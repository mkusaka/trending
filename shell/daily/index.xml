<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub Shell Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2024-10-17T01:35:16Z</updated>
  <subtitle>Daily Trending of Shell in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>itdoginfo/domain-routing-openwrt</title>
    <updated>2024-10-17T01:35:16Z</updated>
    <id>tag:github.com,2024-10-17:/itdoginfo/domain-routing-openwrt</id>
    <link href="https://github.com/itdoginfo/domain-routing-openwrt" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Automatic configuration of Openwrt router for routing by domains. Ansible role and shell script&lt;/p&gt;&lt;hr&gt;&lt;p&gt;&lt;a href=&#34;https://github.com/itdoginfo/domain-routing-openwrt/raw/master/README.EN.md&#34;&gt;English role README&lt;/a&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Описание&lt;/h1&gt; &#xA;&lt;p&gt;Shell скрипт и &lt;a href=&#34;https://galaxy.ansible.com/ui/standalone/roles/itdoginfo/domain_routing_openwrt&#34;&gt;роль для Ansible&lt;/a&gt;. Автоматизируют настройку роутера на OpenWrt для роутинга по доменам и спискам IP-адресов.&lt;/p&gt; &#xA;&lt;p&gt;Полное описание происходящего:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://habr.com/ru/articles/767464/&#34;&gt;Статья на хабре&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://itdog.info/tochechnyj-obhod-blokirovok-po-domenam-na-routere-s-openwrt/&#34;&gt;Копия в моём блоге&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h1&gt;Скрипт для установки&lt;/h1&gt; &#xA;&lt;pre&gt;&lt;code&gt;sh &amp;lt;(wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-install.sh)&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;AmneziaWG&lt;/h2&gt; &#xA;&lt;p&gt;Через этот скрипт можно установить Amnezia wireguard. Скрипт проверяет наличие пакетов под вашу платформу в &lt;a href=&#34;https://github.com/Slava-Shchipunov/awg-openwrt/releases&#34;&gt;стороннем репозитории&lt;/a&gt;, так как в официальном репозитории OpenWRT они отсутствуют, и автоматически их устанавливает.&lt;/p&gt; &#xA;&lt;p&gt;Если подходящих пакетов нет, перед настройкой необходимо будет самостоятельно &lt;a href=&#34;https://github.com/itdoginfo/domain-routing-openwrt/wiki/Amnezia-WG-Build&#34;&gt;собрать бинарники AmneziaWG&lt;/a&gt; для своего устройства и установить их.&lt;/p&gt; &#xA;&lt;h2&gt;Скрипт для проверки конфигурации&lt;/h2&gt; &#xA;&lt;p&gt;Написан для OpenWrt 23.05 и 22.03. На 21.02 работает только половина проверок.&lt;/p&gt; &#xA;&lt;p&gt;[x] - не обязательно означает, что эта часть не работает. Но это повод для ручной проверки.&lt;/p&gt; &#xA;&lt;h3&gt;Запуск&lt;/h3&gt; &#xA;&lt;pre&gt;&lt;code&gt;wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-check.sh | sh&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;По-умолчанию запускается на русском языке. Если нужно запустить на английском, то после &lt;code&gt;sh&lt;/code&gt; нужно добавить &lt;code&gt;-s --lang en&lt;/code&gt;. Аналогично для проверок на подмену DNS и создания дампа.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-check.sh | sh -s --lang en&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Запустить с проверкой на подмену DNS&lt;/h3&gt; &#xA;&lt;pre&gt;&lt;code&gt;wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-check.sh | sh -s dns&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Запустить с созданием dump&lt;/h3&gt; &#xA;&lt;p&gt;Все чувствительные переменные затираются.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;wget -O - https://raw.githubusercontent.com/itdoginfo/domain-routing-openwrt/master/getdomains-check.sh | sh -s dump&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Поиск ошибок вручную: &lt;a href=&#34;https://habr.com/ru/post/702388/&#34;&gt;https://habr.com/ru/post/702388/&lt;/a&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Ansible&lt;/h1&gt; &#xA;&lt;p&gt;Установить роль&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;ansible-galaxy role install itdoginfo.domain_routing_openwrt&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Примеры playbooks&lt;/p&gt; &#xA;&lt;p&gt;Wireguard, only domains, stubby, Russia, acces from wg network (пример 192.168.80.0/24), host 192.168.1.1&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;- hosts: 192.168.1.1&#xA;  remote_user: root&#xA;&#xA;  roles:&#xA;    - itdoginfo.domain_routing_openwrt&#xA;&#xA;  vars:&#xA;    tunnel: wg&#xA;    dns_encrypt: stubby&#xA;    country: russia-inside&#xA;&#xA;    wg_server_address: wg-server-host&#xA;    wg_private_key: privatekey-client&#xA;    wg_public_key: publickey-client&#xA;    wg_preshared_key: presharedkey-client&#xA;    wg_listen_port: 51820&#xA;    wg_client_port: 51820&#xA;    wg_client_address: ip-client&#xA;&#xA;    wg_access: true&#xA;    wg_access_network: wg-network&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Sing-box, stubby, Russia&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;- hosts: 192.168.1.1&#xA;  remote_user: root&#xA;&#xA;  roles:&#xA;    - itdoginfo.domain_routing_openwrt&#xA;&#xA;  vars:&#xA;    tunnel: singbox&#xA;    dns_encrypt: stubby&#xA;    country: russia-inside&#xA;&#xA;  tasks:&#xA;  - name: sing-box config&#xA;    template:&#xA;      src: &#34;templates/openwrt-sing-box-json.j2&#34;&#xA;      dest: &#34;/etc/sing-box/config.json&#34;&#xA;      mode: 0644&#xA;    notify:&#xA;      - Restart sing-box&#xA;      - Restart network&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;В inventory файле роутер обязательно должен быть в группе &lt;code&gt;[openwrt]&lt;/code&gt;&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;[openwrt]&#xA;192.168.1.1&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Для работы Ansible c OpenWrt необходимо, чтоб было выполнено одно из условий:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Отсутствие пароля для root (не рекомендуется)&lt;/li&gt; &#xA; &lt;li&gt;Настроен доступ через публичный SSH-ключ в &lt;a href=&#34;https://openwrt.org/docs/guide-user/security/dropbear.public-key.auth&#34;&gt;конфиге dropbear&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;После выполнения playbook роутер сразу начнёт роутить необходмые домены в туннель/прокси.&lt;/p&gt; &#xA;&lt;p&gt;Если у вас были ошибки и они исправились при повторном запуске playbook, но при этом роутинг не заработал, сделайте рестарт сети и скрипта:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;service network restart&#xA;service getdomains start&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Тестировалось с&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Ansible 2.10.8&lt;/li&gt; &#xA; &lt;li&gt;OpenWrt 21.02.7&lt;/li&gt; &#xA; &lt;li&gt;OpenWrt 22.03.5&lt;/li&gt; &#xA; &lt;li&gt;OpenWrt 23.05.2&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h2&gt;Выбор туннеля&lt;/h2&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Wireguard настраивается автоматически через переменные&lt;/li&gt; &#xA; &lt;li&gt;OpenVPN устанавливается пакет, настраивается роутинг и зона. Само подключение (скопировать конфиг и перезапустить openvpn) нужно &lt;a href=&#34;https://itdog.info/nastrojka-klienta-openvpn-na-openwrt/&#34;&gt;настроить вручную&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;Sing-box устанавливает пакет, настраивается роутинг и зона. Также кладётся темплейт в &lt;code&gt;/etc/sing-box/config.json&lt;/code&gt;. &lt;a href=&#34;https://habr.com/ru/articles/767458/&#34;&gt;Нужно настроить&lt;/a&gt; &lt;code&gt;config.json&lt;/code&gt; и сделать &lt;code&gt;service sing-box restart&lt;/code&gt; Не работает под 21ой версией. Поэтому при его выборе playbook выдаст ошибку. Для 22ой версии нужно установить пакет вручную.&lt;/li&gt; &#xA; &lt;li&gt;tun2socks настраивается только роутинг и зона. Всё остальное нужно настроить вручную&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;Для &lt;strong&gt;tunnel&lt;/strong&gt; шесть возможных значений:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;wg&lt;/li&gt; &#xA; &lt;li&gt;openvpn&lt;/li&gt; &#xA; &lt;li&gt;singbox&lt;/li&gt; &#xA; &lt;li&gt;tun2socks&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;В случае использования WG:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;    wg_server_address: wg-server-host&#xA;    wg_private_key: privatekey-client&#xA;    wg_public_key: publickey-client&#xA;    wg_preshared_key: presharedkey-client&#xA;    wg_client_port: 51820&#xA;    wg_client_address: ip-client&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Если ваш wg сервер не использует &lt;code&gt;preshared_key&lt;/code&gt;, то просто не задавайте её.&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;wg_access&lt;/strong&gt; и &lt;strong&gt;wg_access_network&lt;/strong&gt; для доступа к роутеру через WG. Переменная wg_access_network должна иметь значение подсети, например 192.168.10.0/24.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;    wg_access_network: wg-network&#xA;    wg_access: true&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Шифрование DNS&lt;/h2&gt; &#xA;&lt;p&gt;Если ваш провайдер не подменяет DNS-запросы, ничего устанавливать не нужно.&lt;/p&gt; &#xA;&lt;p&gt;Для &lt;strong&gt;dns_encrypt&lt;/strong&gt; три возможных значения:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;dnscrypt&lt;/li&gt; &#xA; &lt;li&gt;stubby&lt;/li&gt; &#xA; &lt;li&gt;false/закомментировано - пропуск, ничего не устанавливается и не настраивается&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h2&gt;Выбор страны&lt;/h2&gt; &#xA;&lt;p&gt;Выбор списка доменов. Для &lt;strong&gt;county&lt;/strong&gt; три &lt;a href=&#34;https://github.com/itdoginfo/allow-domains&#34;&gt;возможных значения&lt;/a&gt;:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;russia-inside&lt;/li&gt; &#xA; &lt;li&gt;russia-outside&lt;/li&gt; &#xA; &lt;li&gt;ukraine&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h2&gt;Списки IP-адресов&lt;/h2&gt; &#xA;&lt;p&gt;Списки IP-адресов берутся с &lt;a href=&#34;https://antifilter.download/&#34;&gt;antifilter.download&lt;/a&gt; Переменные &lt;strong&gt;list_&lt;/strong&gt; обозначают, какие списки нужно установить. true - установить, false - не устанавливать и удалить, если уже есть&lt;/p&gt; &#xA;&lt;p&gt;Доступные переменные&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;  list_domains: true&#xA;  list_subnet: false&#xA;  list_ip: falses&#xA;  list_community: false&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Я советую использовать только домены&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;    list_domains: true&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Если вам требуются списки IP-адресов, они также поддерживаются.&lt;/p&gt; &#xA;&lt;p&gt;При использовании &lt;strong&gt;list_domains&lt;/strong&gt; нужен пакет dnsmasq-full.&lt;/p&gt; &#xA;&lt;p&gt;Для 23.05 dnsmasq-full устанавливается автоматически.&lt;/p&gt; &#xA;&lt;p&gt;Для OpenWrt 22.03 версия dnsmasq-full должна быть =&amp;gt; 2.87, её нет в официальном репозитории, но можно установить из dev репозитория. Если это условие не выполнено, плейбук завершится с ошибкой.&lt;/p&gt; &#xA;&lt;p&gt;&lt;a href=&#34;https://t.me/itdoginf/12&#34;&gt;Инструкция для OpenWrt 22.03&lt;/a&gt;&lt;/p&gt; &#xA;&lt;p&gt;&lt;a href=&#34;https://t.me/itdoginfo/8&#34;&gt;Инструкция для OpenWrt 21.02&lt;/a&gt;&lt;/p&gt; &#xA;&lt;h2&gt;Текстовый редактор nano&lt;/h2&gt; &#xA;&lt;p&gt;Устанавливается по умолчанию. Можно выключить&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;  nano: false&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;hr&gt; &#xA;&lt;p&gt;&lt;a href=&#34;https://t.me/+lW1HmBO_Fa00M2Iy&#34;&gt;Telegram-канал с обновлениями&lt;/a&gt;&lt;/p&gt;</summary>
  </entry>
</feed>