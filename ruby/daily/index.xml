<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub Ruby Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2024-02-21T01:40:15Z</updated>
  <subtitle>Daily Trending of Ruby in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>danmayer/coverband</title>
    <updated>2024-02-21T01:40:15Z</updated>
    <id>tag:github.com,2024-02-21:/danmayer/coverband</id>
    <link href="https://github.com/danmayer/coverband" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Ruby production code coverage collection and reporting (line of code usage)&lt;/p&gt;&lt;hr&gt;&lt;img src=&#34;https://raw.github.com/danmayer/coverband/master/docs/assets/logo/heads.svg?sanitize=true&#34; width=&#34;300&#34;&gt; &#xA;&lt;h1&gt;Coverband&lt;/h1&gt; &#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/danmayer/coverband/actions&#34;&gt;&lt;img src=&#34;https://github.com/danmayer/coverband/workflows/CI/badge.svg?sanitize=true&#34; alt=&#34;GithubCI&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://coveralls.io/github/danmayer/coverband?branch=master&#34;&gt;&lt;img src=&#34;https://coveralls.io/repos/github/danmayer/coverband/badge.svg?branch=master&#34; alt=&#34;Coverage Status&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://codeclimate.com/github/danmayer/coverband/maintainability&#34;&gt;&lt;img src=&#34;https://api.codeclimate.com/v1/badges/1e6682f9540d75f26da7/maintainability&#34; alt=&#34;Maintainability&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://discord.gg/KAH38EV&#34;&gt;&lt;img src=&#34;https://img.shields.io/discord/609509533999562753&#34; alt=&#34;Discord Shield&#34;&gt;&lt;/a&gt;&lt;/p&gt; &#xA;&lt;p align=&#34;center&#34;&gt; &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#key-features&#34;&gt;Key Features&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#installation&#34;&gt;Installation&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#coverband-web-ui&#34;&gt;Coverband Web UI&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#advanced-config&#34;&gt;Advanced Config&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#newer-features&#34;&gt;Newer Features&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#license&#34;&gt;License&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/changes.md&#34;&gt;Change Log / Roadmap&lt;/a&gt; • &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/CODE_OF_CONDUCT.md&#34;&gt;Code of Conduct&lt;/a&gt; &lt;/p&gt; &#xA;&lt;p&gt;A gem to measure production code usage, showing a counter for the number of times each line of code is executed. Coverband allows easy configuration to collect and report on production code usage. It reports in the background via a thread, can be used as Rack middleware, or can be manually configured to meet any need.&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Coverband is not intended for test code coverage; for that we recommend using &lt;a href=&#34;https://github.com/colszowka/simplecov&#34;&gt;SimpleCov&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;h2&gt;Key Features&lt;/h2&gt; &#xA;&lt;p&gt;The primary goal of Coverband is to give you deep insight into the production runtime usage of your application code, while having the least impact on performance possible.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Low performance overhead&lt;/li&gt; &#xA; &lt;li&gt;Simple setup and configuration&lt;/li&gt; &#xA; &lt;li&gt;Out of the box support for all standard code execution paths (web, cron, background jobs, rake tasks, etc)&lt;/li&gt; &#xA; &lt;li&gt;Splits code loading usage (Rails eager load) and runtime usage metrics&lt;/li&gt; &#xA; &lt;li&gt;Easy to understand actionable insights from the report&lt;/li&gt; &#xA; &lt;li&gt;Mountable web interface to easily share reports&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h1&gt;Installation&lt;/h1&gt; &#xA;&lt;h2&gt;Redis&lt;/h2&gt; &#xA;&lt;p&gt;Coverband stores coverage data in Redis. The Redis endpoint is looked for in this order:&lt;/p&gt; &#xA;&lt;ol&gt; &#xA; &lt;li&gt;&lt;code&gt;ENV[&#39;COVERBAND_REDIS_URL&#39;]&lt;/code&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;code&gt;ENV[&#39;REDIS_URL&#39;]&lt;/code&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;code&gt;localhost:6379&lt;/code&gt;&lt;/li&gt; &#xA;&lt;/ol&gt; &#xA;&lt;p&gt;The redis store can also be explicitly defined within the &lt;code&gt;config/coverband.rb&lt;/code&gt;. See &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#advanced-config&#34;&gt;advanced config&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;h2&gt;Gem Installation&lt;/h2&gt; &#xA;&lt;p&gt;Add this line to your application&#39;s &lt;code&gt;Gemfile&lt;/code&gt;, remember to &lt;code&gt;bundle install&lt;/code&gt; after updating:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;gem &#39;coverband&#39;&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;No custom code or middleware required&lt;/h3&gt; &#xA;&lt;p&gt;With older versions of Coverband, projects would report to redis using rack or sidekiq middleware. After Coverband 4.0, this should no longer be required and could cause performance issues. Reporting to redis is now automatically done within a background thread with no custom code needed.&lt;/p&gt; &#xA;&lt;p&gt;See &lt;a href=&#34;https://github.com/danmayer/coverband/raw/master/changes.md&#34;&gt;changelog&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;h2&gt;Rails&lt;/h2&gt; &#xA;&lt;p&gt;The Railtie integration means you shouldn&#39;t need to do anything else other than ensure Coverband is required after Rails within your Gemfile.&lt;/p&gt; &#xA;&lt;h2&gt;Sinatra&lt;/h2&gt; &#xA;&lt;p&gt;For the best coverage, you want this loaded as early as possible. We recommend requiring cover band directly in the &lt;code&gt;config.ru&lt;/code&gt;. Requiring Coverband within an initializer could also work, but you may end up missing some boot up coverage. To start collection require Coverband as early as possible.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;require &#39;coverband&#39;&#xA;require File.dirname(__FILE__) + &#39;/config/environment&#39;&#xA;&#xA;use Coverband::BackgroundMiddleware&#xA;run ActionController::Dispatcher.new&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Coverband Web UI&lt;/h2&gt; &#xA;&lt;p&gt;&lt;img src=&#34;https://raw.github.com/danmayer/coverband/master/docs/coverband_web_ui.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt; &#xA;&lt;blockquote&gt; &#xA; &lt;p&gt;You can check it out locally by running the &lt;a href=&#34;https://github.com/danmayer/coverband_rails_example&#34;&gt;Coverband Demo App&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;/blockquote&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt; &lt;p&gt;View overall coverage information&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;Drill into individual file coverage&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;View individual file details&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;Clear Coverage - disabled by default as it could be considered a dangerous operation in production. Enable with &lt;code&gt;config.web_enable_clear&lt;/code&gt; or leave off and clear from the &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/#clear-coverage&#34;&gt;rake task&lt;/a&gt;.&lt;/p&gt; &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt; &lt;p&gt;Clear coverage report&lt;/p&gt; &lt;p&gt;This will clear the coverage data. This wipes out all collected data.&lt;/p&gt; &lt;/li&gt; &#xA;   &lt;li&gt; &lt;p&gt;Clear individual file coverage&lt;/p&gt; &lt;p&gt;This will clear the details of the file you are looking at. This is helpful if you don&#39;t want to lose all Coverage data but made a change that you expect would impact a particular file.&lt;/p&gt; &lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;Force coverage collection&lt;/p&gt; &lt;p&gt;This triggers coverage collection on the current webserver process. Useful in development but confusing in production environments where many ruby processes are usually running.&lt;/p&gt; &lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Mounting as a Rack App&lt;/h3&gt; &#xA;&lt;p&gt;Coverband comes with a mountable rack app for viewing reports. For Rails this can be done in &lt;code&gt;config/routes.rb&lt;/code&gt; with:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;Rails.application.routes.draw do&#xA;  mount Coverband::Reporters::Web.new, at: &#39;/coverage&#39;&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;But don&#39;t forget to &lt;em&gt;protect your source code with proper authentication&lt;/em&gt;. Something like this when using devise:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;Rails.application.routes.draw do&#xA;  authenticate :user, lambda { |u| u.admin? } do&#xA;    mount Coverband::Reporters::Web.new, at: &#39;/coverage&#39;&#xA;  end&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;or you can enable basic auth by setting &lt;code&gt;ENV[&#39;COVERBAND_PASSWORD&#39;]&lt;/code&gt; or via your configuration &lt;code&gt;config.password = &amp;lt;YOUR_COMPLEX_UNGUESSABLE_PASSWORD&amp;gt;&lt;/code&gt;&lt;/p&gt; &#xA;&lt;h3&gt;Standalone&lt;/h3&gt; &#xA;&lt;p&gt;The coverage server can also be started standalone with a rake task:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;bundle exec rake coverband:coverage_server&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;The web UI should then be available here: &lt;a href=&#34;http://localhost:9022/&#34;&gt;http://localhost:9022/&lt;/a&gt;&lt;/p&gt; &#xA;&lt;p&gt;If you want to run on an alternative port:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;COVERBAND_COVERAGE_PORT=8086 bundle exec rake coverband:coverage_server&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;This is especially useful for projects that are api only and cannot support the mounted rack app. To get production coverage, point Coverband at your production redis server and ensure to checkout the production version of your project code locally.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt; COVERBAND_REDIS_URL=redis://username:password@redis_production_server:2322 bundle exec rake coverband:coverage_server&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h1&gt;Coverband Demo&lt;/h1&gt; &#xA;&lt;p&gt;Take Coverband for a spin on the live Heroku deployed &lt;a href=&#34;https://coverband-demo.herokuapp.com/&#34;&gt;Coverband Demo&lt;/a&gt;. The &lt;a href=&#34;https://github.com/danmayer/coverband_demo&#34;&gt;full source code for the demo&lt;/a&gt; is available to help with installation, configuration, and understanding of basic usage.&lt;/p&gt; &#xA;&lt;h3&gt;Example apps&lt;/h3&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/danmayer/coverband_demo&#34;&gt;Rails 5.2.x App&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/danmayer/churn-site&#34;&gt;Sinatra app&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/danmayer/coverband_examples&#34;&gt;Non Rack Ruby app&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h1&gt;Advanced Config&lt;/h1&gt; &#xA;&lt;p&gt;If you need to configure Coverband, this can be done by creating a &lt;code&gt;config/coverband.rb&lt;/code&gt; file relative to your project root.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;See &lt;a href=&#34;https://github.com/danmayer/coverband/raw/master/lib/coverband/configuration.rb&#34;&gt;lib/coverband/configuration.rb&lt;/a&gt; for all options&lt;/li&gt; &#xA; &lt;li&gt;By default Coverband will try to store data to Redis * Redis endpoint is looked for in this order: &lt;code&gt;ENV[&#39;COVERBAND_REDIS_URL&#39;]&lt;/code&gt;, &lt;code&gt;ENV[&#39;REDIS_URL&#39;]&lt;/code&gt;, or &lt;code&gt;localhost&lt;/code&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;Below is an example config file for a Rails 5 app:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;# config/coverband.rb NOT in the initializers&#xA;Coverband.configure do |config|&#xA;  config.store = Coverband::Adapters::RedisStore.new(Redis.new(url: ENV[&#39;MY_REDIS_URL&#39;]))&#xA;  config.logger = Rails.logger&#xA;&#xA;  # config options false, true. (defaults to false)&#xA;  # true and debug can give helpful and interesting code usage information&#xA;  # and is safe to use if one is investigating issues in production, but it will slightly&#xA;  # hit perf.&#xA;  config.verbose = false&#xA;&#xA;  # default false. button at the top of the web interface which clears all data&#xA;  config.web_enable_clear = true&#xA;&#xA;  # default false. Experimental support for routes usage tracking.&#xA;  config.track_routes = true&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Working with environment variables&lt;/h3&gt; &#xA;&lt;p&gt;Do you use figaro, mc-settings, dotenv or something else to inject environment variables into your app? If so ensure you have that done BEFORE Coverband is required.&lt;/p&gt; &#xA;&lt;p&gt;For example if you use dotenv, you need to do this, see &lt;a href=&#34;https://github.com/bkeepers/dotenv#note-on-load-order&#34;&gt;https://github.com/bkeepers/dotenv#note-on-load-order&lt;/a&gt;&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;gem &#39;dotenv-rails&#39;, require: &#39;dotenv/rails-now&#39;&#xA;gem &#39;coverband&#39;&#xA;gem &#39;other-gem-that-requires-env-variables&#39;&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Ignoring Files&lt;/h3&gt; &#xA;&lt;p&gt;Sometimes you have files that are known to be valuable, perhaps in other environments or something that is just run very infrequently. Opposed to having to mentally filter them out of the report, you can just have them ignored in the Coverband reporting by using &lt;code&gt;config.ignore&lt;/code&gt; as shown below. Ignore takes a string but can also match with regex rules see how below ignores all rake tasks as an example.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;config.ignore +=  [&#39;config/application.rb&#39;,&#xA;                   &#39;config/boot.rb&#39;,&#xA;                   &#39;config/puma.rb&#39;,&#xA;                   &#39;config/schedule.rb&#39;,&#xA;                   &#39;bin/.*&#39;,&#xA;                   &#39;config/environments/.*&#39;,&#xA;                   &#39;lib/tasks/.*&#39;]&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;&lt;strong&gt;Ignoring Custom Gem Locations:&lt;/strong&gt; Note, if you have your gems in a custom location under your app folder you likely want to add them to &lt;code&gt;config.ignore&lt;/code&gt;. For example, if you have your gems not in the default ignored location of &lt;code&gt;app/vendor&lt;/code&gt; but in &lt;code&gt;app/gems&lt;/code&gt;, you would need to add &lt;code&gt;gems/*&lt;/code&gt; to your ignore list.&lt;/p&gt; &#xA;&lt;h3&gt;View Tracking&lt;/h3&gt; &#xA;&lt;p&gt;Coverband allows an optional feature to track all view files that are used by an application.&lt;/p&gt; &#xA;&lt;p&gt;This feature is enabled by default. To stop this feature, disable the feature in your Coverband config.&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;config.track_views = false&lt;/code&gt;&lt;/p&gt; &#xA;&lt;p&gt;&lt;img src=&#34;https://raw.github.com/danmayer/coverband/master/docs/coverband_view_tracker.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt; &#xA;&lt;h3&gt;Fixing Coverage Only Shows Loading Hits&lt;/h3&gt; &#xA;&lt;p&gt;If all your coverage is being counted as loading or eager_loading coverage, and nothing is showing as runtime Coverage the initialization hook failed for some reason. The most likely reason for this issue is manually calling &lt;code&gt;eager_load!&lt;/code&gt; on some Plugin/Gem. If you or a plugin is altering the Rails initialization process, you can manually flip Coverband to runtime coverage by calling these two lines, in an &lt;code&gt;after_initialize&lt;/code&gt; block, in &lt;code&gt;application.rb&lt;/code&gt;.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;config.after_initialize do&#xA;  unless Coverband.tasks_to_ignore?&#xA;    Coverband.report_coverage # record the last of the loading coverage&#xA;    Coverband.runtime_coverage! # set all future coverage to runtime&#xA;  end&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;or if you know you are manually calling eager load anywhere in your initialization process immediately after call those two lines. A user reported an issue after calling &lt;code&gt;ResqueWeb::Engine.eager_load!&lt;/code&gt; for example.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;Rails.application.routes.draw do&#xA;  ResqueWeb::Engine.eager_load!&#xA;  Coverband.report_coverage&#xA;  Coverband.runtime_coverage!&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Avoiding Cache Stampede&lt;/h3&gt; &#xA;&lt;p&gt;If you have many servers and they all hit Redis at the same time you can see spikes in your Redis CPU, and memory. This is due to a concept called &lt;a href=&#34;https://en.wikipedia.org/wiki/Cache_stampede&#34;&gt;cache stampede&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;p&gt;It is better to spread out the reporting across your servers. A simple way to do this is to add a random wiggle on your background reporting. This configuration option allows a wiggle. The right amount of wiggle depends on the number of servers you have and how willing you are to have delays in your coverage reporting. I would recommend at least 1 second per server. Note, the default wiggle is set to 30 seconds.&lt;/p&gt; &#xA;&lt;p&gt;Add a wiggle (in seconds) to the background thread to avoid all your servers reporting at the same time:&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;config.reporting_wiggle = 30&lt;/code&gt;&lt;/p&gt; &#xA;&lt;p&gt;Another way to avoid cache stampede is to omit some reporting on starting servers. Coverband stores the results of eager_loading to Redis at server startup. The eager_loading results are the same for all servers, so there is no need to save all results. By configuring the eager_loading results of some servers to be stored in Redis, we can reduce the load on Redis during deployment.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;# To omit reporting on starting servers, need to defer saving eager_loading data&#xA;config.defer_eager_loading_data = true&#xA;# Store eager_loading data on 5% of servers&#xA;config.send_deferred_eager_loading_data = rand(100) &amp;lt; 5&#xA;# Store eager_loading data on servers with the environment variable&#xA;config.send_deferred_eager_loading_data = ENV.fetch(&#39;ENABLE_EAGER_LOADING_COVERAGE&#39;, false)&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Redis Hash Store&lt;/h3&gt; &#xA;&lt;p&gt;Coverband on very high volume sites with many server processes reporting can have a race condition which can cause hit counts to be inaccurate. To resolve the race condition and reduce Ruby memory overhead we have introduced a new Redis storage option. This moves the some of the work from the Ruby processes to Redis. It is worth noting because of this, it has larger demands on the Redis server. So adjust your Redis instance accordingly. To help reduce the extra redis load you can also change the background reporting frequency.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Use a dedicated Coverband redis instance: &lt;code&gt;config.store = Coverband::Adapters::HashRedisStore.new(Redis.new(url: redis_url))&lt;/code&gt;&lt;/li&gt; &#xA; &lt;li&gt;Adjust from default 30s reporting &lt;code&gt;config.background_reporting_sleep_seconds = 120&lt;/code&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;See more discussion &lt;a href=&#34;https://github.com/danmayer/coverband/issues/384&#34;&gt;here&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;p&gt;Please note that with the Redis Hash Store, everytime you load the full report, Coverband will execute &lt;code&gt;HGETALL&lt;/code&gt; queries in your Redis server twice for every file in the project (once for runtime coverage and once for eager loading coverage). This shouldn&#39;t have a big impact in small to medium projects, but can be quite a hassle if your project has a few thousand files. To help reduce the extra redis load when getting the coverage report, you can enable &lt;code&gt;get_coverage_cache&lt;/code&gt; (but note that when doing that, you will always get a previous version of the report, while a cache is re-populated with a newer version).&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Use Hash Redis Store with &lt;em&gt;get coverage cache&lt;/em&gt;: &lt;code&gt;config.store = Coverband::Adapters::HashRedisStore.new(redis, get_coverage_cache: true)&lt;/code&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Clear Coverage&lt;/h3&gt; &#xA;&lt;p&gt;Now that Coverband uses MD5 hashes there should be no reason to manually clear coverage unless one is testing, changing versions, or possibly debugging Coverband itself.&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;rake coverband:clear&lt;/code&gt;&lt;/p&gt; &#xA;&lt;p&gt;This can also be done through the web if &lt;code&gt;config.web_enable_clear&lt;/code&gt; is enabled.&lt;/p&gt; &#xA;&lt;h3&gt;Coverage Data Migration&lt;/h3&gt; &#xA;&lt;p&gt;Between the release of 4.0 and 4.1 our data format changed. This resets all your coverage data. If you want to restore your previous coverage data, feel free to migrate.&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;rake coverband:migrate&lt;/code&gt;&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;We will be working to support migrations going forward, when possible&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Adding Rake Tasks outside of Rails&lt;/h3&gt; &#xA;&lt;p&gt;Rails apps should automatically include the tasks via the Railtie.&lt;/p&gt; &#xA;&lt;p&gt;For non Rails apps, either add the below to your &lt;code&gt;Rakefile&lt;/code&gt; or to a file included in your &lt;code&gt;Rakefile&lt;/code&gt; such as &lt;code&gt;lib/tasks/coverband.rake&lt;/code&gt; if you want to break it up that way.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;require &#39;coverband&#39;&#xA;Coverband.configure&#xA;require &#39;coverband/utils/tasks&#39;&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Verify it works&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;rake -T coverband&#xA;rake coverband:clear         # reset coverband coverage data&#xA;rake coverband:coverage      # report runtime coverband code coverage&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Manually Starting Coverband&lt;/h3&gt; &#xA;&lt;p&gt;Coverband starts on require of the the library which is usually done within the Gemfile. This can be disabled by setting the &lt;code&gt;COVERBAND_DISABLE_AUTO_START&lt;/code&gt; environment variable. This environment variable can be useful to toggle Coverband on and off in certain environments.&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; That any value set for &lt;code&gt;COVERBAND_DISABLE_AUTO_START&lt;/code&gt; is considered true, it does not match the string content but only checks the presence of the ENV variable.&lt;/p&gt; &#xA;&lt;p&gt;In order to start Coverband manually when this flag is enabled, call &lt;code&gt;Coverband.configure&lt;/code&gt; followed by &lt;code&gt;Coverband.start&lt;/code&gt;.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;Coverband.configure&#xA;Coverband.start&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Verbose Debug / Development Mode&lt;/h3&gt; &#xA;&lt;p&gt;Note: To debug issues getting Coverband working. I recommend running in development mode, by turning verbose logging on &lt;code&gt;config.verbose = true&lt;/code&gt; and passing in the Rails.logger &lt;code&gt;config.logger = Rails.logger&lt;/code&gt; to the Coverband config. We respect the log level, and I would recommend log level info generally, but if you are investigating a problem Coverband logs additional data at the &lt;code&gt;debug&lt;/code&gt; level. This makes it easy to follow in development mode. Be careful not to leave these on in production as they will affect performance.&lt;/p&gt; &#xA;&lt;hr&gt; &#xA;&lt;p&gt;If you are trying to debug locally wondering what code is being run during a request. The verbose modes &lt;code&gt;config.verbose = true&lt;/code&gt; &amp;amp;&amp;amp; &lt;code&gt;Rails.logger.level = :debug&lt;/code&gt;. With true set it will output the number of lines executed per file, to the passed in log.&lt;/p&gt; &#xA;&lt;h3&gt;Solving: stack level too deep errors&lt;/h3&gt; &#xA;&lt;p&gt;If you start seeing SystemStackError: stack level too deep errors from background jobs after installing Coverband, this means there is another patch for ResqueWorker that conflicts with Coverband&#39;s patch in your application. To fix this, change Coverband gem line in your Gemfile to the following:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;gem &#39;coverband&#39;, require: [&#39;alternative_coverband_patch&#39;, &#39;coverband&#39;]&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;If you currently have require: false, remove the &#39;coverband&#39; string from the require array above so the gem line becomes like this:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;gem &#39;coverband&#39;, require: [&#39;alternative_coverband_patch&#39;]&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;This conflict happens when a ruby method is patched twice, once using module prepend, and once using method aliasing. See this ruby issue for details. The fix is to apply all patches the same way. By default, Coverband will apply its patch using prepend, but you can change that to method aliasing by adding require: [&#39;alternative_coverband_patch&#39;] to the gem line as shown above.&lt;/p&gt; &#xA;&lt;h3&gt;Redis Sizing Info&lt;/h3&gt; &#xA;&lt;p&gt;A few folks have asked about what size of Redis is needed to run Coverband. I have some of our largest services with hundreds of servers on cache.m3.medium with plenty of room to spare. I run most apps on the smallest AWS Redis instances available and bump up only if needed or if I am forced to be on a shared Redis instance, which I try to avoid. On Heroku, I have used it with most of the 3rd party and also been fine on the smallest Redis instances, if you have hundreds of dynos you would likely need to scale up. Also note there is a tradeoff one can make, &lt;code&gt;Coverband::Adapters::HashRedisStore&lt;/code&gt; will use LUA on Redis and increase the Redis load, while being nicer to your app servers and avoid potential lost data during race conditions. While the &lt;code&gt;Coverband::Adapters::RedisStore&lt;/code&gt; uses in app memory and merging and has lower load on Redis.&lt;/p&gt; &#xA;&lt;h1&gt;Newer Features&lt;/h1&gt; &#xA;&lt;h3&gt;Dead Method Scanning (ruby 2.6+)&lt;/h3&gt; &#xA;&lt;p&gt;Rake task that outputs dead methods based on current coverage data:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;bundle exec rake coverband:dead_methods&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;Outputs:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;---------------------------------------------------------------------------------------------------&#xA;| file                                  | class           | method                  | line_number |&#xA;| ./config/routes.rb                    | AdminConstraint | matches?                | 20          |&#xA;| ./app/controllers/home_controller.rb  | HomeController  | trigger_jobs            | 8           |&#xA;| ./app/controllers/home_controller.rb  | HomeController  | data_tracer             | 14          |&#xA;| ./app/controllers/posts_controller.rb | PostsController | edit                    | 22          |&#xA;| ./app/controllers/posts_controller.rb | PostsController | destroy_bad_dangerously | 73          |&#xA;---------------------------------------------------------------------------------------------------&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h1&gt;Prerequisites&lt;/h1&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Coverband 3.0.X+ requires Ruby 2.3+&lt;/li&gt; &#xA; &lt;li&gt;Coverband currently requires Redis for production usage&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Ruby and Rails Version Support&lt;/h3&gt; &#xA;&lt;p&gt;We will match Heroku &amp;amp; Ruby&#39;s support lifetime, supporting the last 3 major Ruby releases. For details see &lt;a href=&#34;https://devcenter.heroku.com/articles/ruby-support#supported-runtimes&#34;&gt;supported runtimes&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;p&gt;For Rails, we will follow the policy of the &lt;a href=&#34;https://guides.rubyonrails.org/maintenance_policy.html&#34;&gt;Rails team maintenance policy&lt;/a&gt;. We officially support the last two major release versions, while providing minimal support (major bugs / security fixes) for an additional version. This means at the moment we primarily target Rails 6.x, 5.x, and will try to keep current functionality working for Rails 4.x but may release new features that do not work on that target.&lt;/p&gt; &#xA;&lt;h3&gt;JRuby Support&lt;/h3&gt; &#xA;&lt;p&gt;Coverband is compatible with JRuby. If you want to run on JRuby note that I haven&#39;t benchmarked and I believe the perf impact on older versions of JRuby could be significant. Improved Coverage support is in &lt;a href=&#34;https://github.com/jruby/jruby/pull/6180&#34;&gt;JRuby master&lt;/a&gt;, and will be in the next release.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;older versions of JRuby need tracing enabled to work (and this could cause bad performance) &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;run Jruby with the &lt;code&gt;--debug&lt;/code&gt; option&lt;/li&gt; &#xA;   &lt;li&gt;add into your &lt;code&gt;.jrubyrc&lt;/code&gt; the &lt;code&gt;debug.fullTrace=true&lt;/code&gt; setting&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;For best performance the &lt;code&gt;oneshot_lines&lt;/code&gt; is recommended, and in the latest releases should have very low overhead&lt;/li&gt; &#xA; &lt;li&gt;See JRuby support in a Rails app configured to run via JRuby, in &lt;a href=&#34;https://github.com/coverband-service/coverband_demo&#34;&gt;Coverband Demo&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;JRuby is tested via CI against Rails 5 and 6&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h1&gt;Contributing To Coverband&lt;/h1&gt; &#xA;&lt;p&gt;If you are working on adding features, PRs, or bugfixes to Coverband this section should help get you going.&lt;/p&gt; &#xA;&lt;ol&gt; &#xA; &lt;li&gt;Fork it&lt;/li&gt; &#xA; &lt;li&gt;Create your feature branch (&lt;code&gt;git checkout -b my-new-feature&lt;/code&gt;)&lt;/li&gt; &#xA; &lt;li&gt;Commit your changes (&lt;code&gt;git commit -am &#39;Add some feature&#39;&lt;/code&gt;)&lt;/li&gt; &#xA; &lt;li&gt;Push to the branch (&lt;code&gt;git push origin my-new-feature&lt;/code&gt;)&lt;/li&gt; &#xA; &lt;li&gt;Make sure all tests are passing (run &lt;code&gt;bundle install&lt;/code&gt;, make sure Redis is running, and then execute &lt;code&gt;rake test&lt;/code&gt;)&lt;/li&gt; &#xA; &lt;li&gt;Create new Pull Request&lt;/li&gt; &#xA;&lt;/ol&gt; &#xA;&lt;h3&gt;Tests &amp;amp; Benchmarks&lt;/h3&gt; &#xA;&lt;p&gt;If you submit a change please make sure the tests and benchmarks are passing.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;run tests: &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;&lt;code&gt;bundle exec rake&lt;/code&gt;&lt;/li&gt; &#xA;   &lt;li&gt;&lt;code&gt;BUNDLE_GEMFILE=Gemfile.rails7 bundle exec rake&lt;/code&gt; (Same tests using rails 7 instead of 6)&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;view test coverage: &lt;code&gt;open coverage/index.html&lt;/code&gt;&lt;/li&gt; &#xA; &lt;li&gt;run the benchmarks before and after your change to see impact &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;&lt;code&gt;rake benchmarks&lt;/code&gt;&lt;/li&gt; &#xA;   &lt;li&gt;run a single test by line number like rspec: &lt;code&gt;bundle exec m test/coverband/reporters/html_test.rb:29&lt;/code&gt;&lt;/li&gt; &#xA;   &lt;li&gt;run a single test file: &lt;code&gt;bundle exec ruby test/coverband/collectors/translation_tracker_test.rb&lt;/code&gt;&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Known Issues&lt;/h3&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;strong&gt;total fail&lt;/strong&gt; on front end code, for line for line coverage, because of the precompiled template step basically coverage doesn&#39;t work well for &lt;code&gt;erb&lt;/code&gt;, &lt;code&gt;slim&lt;/code&gt;, and the like. &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;related it will try to report something, but the line numbers reported for &lt;code&gt;ERB&lt;/code&gt; files are often off and aren&#39;t considered useful. I recommend filtering out .erb using the &lt;code&gt;config.ignore&lt;/code&gt; option. The default configuration excludes these files&lt;/li&gt; &#xA;   &lt;li&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; We now have file level coverage for view files, but don&#39;t support line level detail&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Coverage does NOT work when used alongside Scout APM Auto Instrumentation&lt;/strong&gt; &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;In an environment that uses Scout&#39;s &lt;code&gt;AUTO_INSTRUMENT=true&lt;/code&gt; (usually production or staging) it stops reporting any coverage, it will show one or two files that have been loaded at the start but everything else will show up as having 0% coverage&lt;/li&gt; &#xA;   &lt;li&gt;Bug tracked here: &lt;a href=&#34;https://github.com/scoutapp/scout_apm_ruby/issues/343&#34;&gt;https://github.com/scoutapp/scout_apm_ruby/issues/343&lt;/a&gt;&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Coverband, &lt;a href=&#34;https://github.com/elastic/apm-agent-ruby&#34;&gt;Elastic APM&lt;/a&gt; and resque&lt;/strong&gt; &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;In an environment that uses the Elastic APM ruby agent, resque jobs will fail with &lt;code&gt;Transactions may not be nested. Already inside #&amp;lt;ElasticAPM::Transaction&amp;gt;&lt;/code&gt; if the &lt;code&gt;elastic-apm&lt;/code&gt; gem is loaded &lt;em&gt;before&lt;/em&gt; the &lt;code&gt;coverband&lt;/code&gt; gem&lt;/li&gt; &#xA;   &lt;li&gt;Put &lt;code&gt;coverage&lt;/code&gt; ahead of &lt;code&gt;elastic-apm&lt;/code&gt; in your Gemfile&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Bootsnap&lt;/strong&gt;, The methods used by &lt;a href=&#34;https://github.com/Shopify/bootsnap/raw/main/lib/bootsnap/compile_cache/iseq.rb#L87&#34;&gt;bootsnap do not support having coverage enabled&lt;/a&gt;, so you can either have Coverband or bootsnap, but not both.&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Debugging Redis Store&lt;/h3&gt; &#xA;&lt;p&gt;What files have been synced to Redis?&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;Coverband.configuration.store.covered_files&lt;/code&gt;&lt;/p&gt; &#xA;&lt;p&gt;What is the coverage data in Redis?&lt;/p&gt; &#xA;&lt;p&gt;&lt;code&gt;Coverband.configuration.store.coverage&lt;/code&gt;&lt;/p&gt; &#xA;&lt;h3&gt;Diagram&lt;/h3&gt; &#xA;&lt;p&gt;A diagram of the code.&lt;/p&gt; &#xA;&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/danmayer/coverband/diagram/diagram.svg?sanitize=true&#34; alt=&#34;Visualization of this repo&#34;&gt;&lt;/p&gt; &#xA;&lt;h2&gt;Logo&lt;/h2&gt; &#xA;&lt;p&gt;The Coverband logo was created by &lt;a href=&#34;http://davewoodall.com&#34;&gt;Dave Woodall&lt;/a&gt;. Thanks Dave!&lt;/p&gt; &#xA;&lt;h1&gt;License&lt;/h1&gt; &#xA;&lt;p&gt;This is a MIT License project... See the file &lt;a href=&#34;https://raw.githubusercontent.com/danmayer/coverband/main/LICENSE&#34;&gt;LICENSE&lt;/a&gt; for copying permission.&lt;/p&gt;</summary>
  </entry>
</feed>