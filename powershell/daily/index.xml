<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub PowerShell Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2023-11-30T01:39:31Z</updated>
  <subtitle>Daily Trending of PowerShell in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>jborean93/PowerShell-ALC</title>
    <updated>2023-11-30T01:39:31Z</updated>
    <id>tag:github.com,2023-11-30:/jborean93/PowerShell-ALC</id>
    <link href="https://github.com/jborean93/PowerShell-ALC" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Example ALC structures to use with in a PowerShell module&lt;/p&gt;&lt;hr&gt;&lt;h1&gt;PowerShell Assembly Load Contexts&lt;/h1&gt; &#xA;&lt;p&gt;This repo is designed to go through the various ways to use an Assembly Load Context (&lt;code&gt;ALC&lt;/code&gt;) in a PowerShell module. An ALC is a new mechanism introduced with .NET 5 that provides a way to load multiple versions of the same assembly into the same process. It can be used in PowerShell to build a module with a dependency that might conflict with something provided by PowerShell or another module that has already been imported.&lt;/p&gt; &#xA;&lt;p&gt;I found that the guides online didn&#39;t cover all the mechanisms or showed real working examples of it all setup. I would like to call out the following links which do cover a lot of the ground here and are great fundamentals for understanding the concept behind an ALC:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://learn.microsoft.com/en-us/powershell/scripting/dev-cross-plat/resolving-dependency-conflicts?view=powershell-7.4&#34;&gt;https://learn.microsoft.com/en-us/powershell/scripting/dev-cross-plat/resolving-dependency-conflicts?view=powershell-7.4&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://pipe.how/get-assemblyloadcontext/&#34;&gt;https://pipe.how/get-assemblyloadcontext/&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;There are two ways I know how to use an ALC in PowerShell modules:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://raw.githubusercontent.com/jborean93/PowerShell-ALC/main/ALCLoader/README.md&#34;&gt;ALC Loader&lt;/a&gt; - loads our binary module in a ALC directly&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://raw.githubusercontent.com/jborean93/PowerShell-ALC/main/ALCLoader/README.md&#34;&gt;ALC Resolver&lt;/a&gt; - loads our binary module normally and the deps with an ALC resolver&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;These are not official names but how I will refer to these methods going forward. I personally recommend the &lt;a href=&#34;https://raw.githubusercontent.com/jborean93/PowerShell-ALC/main/ALCLoader/README.md&#34;&gt;ALC Loader&lt;/a&gt; method when starting a new project as:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;It ensures all deps are placed in the ALC and nothing is missed&lt;/li&gt; &#xA; &lt;li&gt;Cmdlets can interact directly with the deps without a wrapper assembly making the code simpler&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;An ALC typically needs to be used as a binary module but it is technically possible to use it in a pure PowerShell script module. See &lt;a href=&#34;https://raw.githubusercontent.com/jborean93/PowerShell-ALC/main/ALCScriptModule/README.md&#34;&gt;ALC ScriptModule&lt;/a&gt; or &lt;a href=&#34;https://raw.githubusercontent.com/jborean93/PowerShell-ALC/main/ALCPureScriptModule/README.md&#34;&gt;ALC Pure ScriptModule&lt;/a&gt; for more details on this approach.&lt;/p&gt; &#xA;&lt;h2&gt;Testing&lt;/h2&gt; &#xA;&lt;p&gt;The &lt;code&gt;./test.ps1&lt;/code&gt; script can be used to build an example module and run through some basic scenarios.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-powershell&#34;&gt;pwsh.exe -File ./test.ps1 -Name ALCLoader&#xA;pwsh.exe -File ./test.ps1 -Name ALCResolver&#xA;pwsh.exe -File ./test.ps1 -Name ALCScriptModule&#xA;pwsh.exe -File ./test.ps1 -Name ALCPureScriptModule&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;These scenarios are all the same in each example and show how the assemblies are loaded and that the code actually works. Please note the &lt;code&gt;GAC&lt;/code&gt; tests require you to be running as admin. The tests go through 6 different scenarios:&lt;/p&gt; &#xA;&lt;table&gt; &#xA; &lt;thead&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;th&gt;Scenario&lt;/th&gt; &#xA;   &lt;th&gt;Outcome&lt;/th&gt; &#xA;  &lt;/tr&gt; &#xA; &lt;/thead&gt; &#xA; &lt;tbody&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;WinPS&lt;/td&gt; &#xA;   &lt;td&gt;Loads the module&#39;s assembly&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;WinPS Same version already loaded&lt;/td&gt; &#xA;   &lt;td&gt;Already loaded assembly&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;WinPS Older version already loaded&lt;/td&gt; &#xA;   &lt;td&gt;Loads the module&#39;s assembly&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;PS&lt;/td&gt; &#xA;   &lt;td&gt;Loads the module&#39;s assembly in an ALC&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;PS Same version already loaded&lt;/td&gt; &#xA;   &lt;td&gt;Loads the module&#39;s assembly in an ALC*&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td&gt;PS Older version already loaded&lt;/td&gt; &#xA;   &lt;td&gt;Loads the module&#39;s assembly in an ALC&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA; &lt;/tbody&gt; &#xA;&lt;/table&gt; &#xA;&lt;p&gt;&lt;em&gt;*: &lt;code&gt;ALCResolver&lt;/code&gt; will use the existing loaded assembly rather than load a new one in the ALC.&lt;/em&gt;&lt;/p&gt; &#xA;&lt;p&gt;The main difference between WinPS and PS here is that PS will always load our dependencies in the ALC while WinPS only load our assembly if there is not an existing assembly that matches the name/version. WinPS can load the same assembly at different versions so this should avoid any version conflicts in the majority of cases.&lt;/p&gt; &#xA;&lt;h2&gt;Things to Avoid&lt;/h2&gt; &#xA;&lt;p&gt;When using an ALC you should avoid:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Use an ALC type as your cmdlet&#39;s parameters or outputs&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;It is possible to output an object of a type from an assembly loaded in an ALC but it should be avoided as much as possible. This won&#39;t cause PowerShell to then load the assembly but it will be unable to reference the type. For example this won&#39;t work because &lt;code&gt;[Assembly.In.Alc.Type]&lt;/code&gt; is not resolvable in PowerShell and if it was the type won&#39;t match the type loaded in the ALC.&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ps&#34;&gt;$obj = Test-Function&#xA;$obj -is [Assembly.In.Alc.Type]&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;This will also be problematic if you try to create a function with a parameter of a type in the ALC&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-ps&#34;&gt;Function Test-Function {&#xA;    [CmdletBinding()]&#xA;    param (&#xA;        [Assembly.In.Alc.Type]$Object&#xA;    )&#xA;}&#xA;&#xA;$obj = Get-ModuleItem&#xA;Test-Function -Object $obj&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;The same problem applies where the type may not be resolvable in PowerShell and if it was will be for a different assembly than the one from the ALC that created the type giving you the confusing error:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;The type &#39;Assembly.In.Alc.Type&#39; cannot be casted to the type &#39;Assembly.In.Alc.Type&#39;&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Real World Examples&lt;/h2&gt; &#xA;&lt;p&gt;Some real world examples of modules that use an ALC are:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/jborean93/PowerShell-OpenAuthenticode&#34;&gt;OpenAuthenticode&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/PowerShell/PowerShellEditorServices&#34;&gt;PowerShellEditorServices&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/jborean93/PSOpenAD&#34;&gt;PSOpenAD&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/jborean93/PSToml&#34;&gt;PSToml&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/jborean93/SecretManagement.DpapiNG&#34;&gt;SecretManagement.DpapiNG&lt;/a&gt; &#xA;  &lt;ul&gt; &#xA;   &lt;li&gt;This also is a &lt;a href=&#34;https://github.com/PowerShell/SecretManagement&#34;&gt;SecretManagement&lt;/a&gt; implementation&lt;/li&gt; &#xA;  &lt;/ul&gt; &lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/jborean93/PowerShell-Yayaml&#34;&gt;Yayaml&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;Thanks to&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;@seeminglyscience who came up with the &lt;code&gt;ALC Loader&lt;/code&gt; example and helped me through some questions I had&lt;/li&gt; &#xA; &lt;li&gt;@JustinGrote who came up with some ideas to try out and talk through some scenarios to test&lt;/li&gt; &#xA;&lt;/ul&gt;</summary>
  </entry>
</feed>