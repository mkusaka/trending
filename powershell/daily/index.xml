<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub PowerShell Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2022-08-13T01:51:00Z</updated>
  <subtitle>Daily Trending of PowerShell in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>NetSPI/PowerHuntShares</title>
    <updated>2022-08-13T01:51:00Z</updated>
    <id>tag:github.com,2022-08-13:/NetSPI/PowerHuntShares</id>
    <link href="https://github.com/NetSPI/PowerHuntShares" rel="alternate"></link>
    <summary type="html">&lt;p&gt;PowerHuntShares is an audit script designed in inventory, analyze, and report excessive privileges configured on Active Directory domains.&lt;/p&gt;&lt;hr&gt;&lt;h1&gt;PowerHuntShares&lt;/h1&gt; &#xA;&lt;p&gt;PowerHuntShares is design to automatically inventory, analyze, and report excessive privilege assigned to SMB shares on Active Directory domain joined computers.&lt;br&gt; It is intented to help IAM and other blue teams gain a better understand of their SMB Share attack surface and provides data insights to help naturally group related share to help stream line remediation efforts at scale.&lt;/p&gt; &#xA;&lt;p&gt;It supports functionality to:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;strong&gt;Authenticate&lt;/strong&gt; using the current user context, a credential, or clear text user/password.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Discover&lt;/strong&gt; accessible systems associated with an Active Directory domain automatically. It will also filter Active Directory computers based on available open ports.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Target&lt;/strong&gt; a single computer, list of computers, or discovered Active Directory computers (default).&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Collect&lt;/strong&gt; SMB share ACL information from target computers using PowerShell.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Analyze&lt;/strong&gt; collected Share ACL data.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;Report&lt;/strong&gt; summary reports and excessive privilege details in HTML and CSV file formats.&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;Excessive SMB share ACLs are a systemic problem and an attack surface that all organizations struggle with. The goal of this project is to provide a proof concept that will work towards building a better share collection and data insight engine that can help inform and priorititize remediation efforts. &lt;br&gt;&lt;br&gt; Bonus Features: &lt;br&gt;&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Generate directory listing dump for configurable depth&lt;/li&gt; &#xA; &lt;li&gt;Search for file types across discovered shares&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;I&#39;ve also put together a short presentation outlining some of the common misconfigurations and strategies for prioritizing remediation here: &lt;a href=&#34;https://www.slideshare.net/nullbind/into-the-abyss-evaluating-active-directory-smb-shares-on-scale-secure360-251762721&#34;&gt;https://www.slideshare.net/nullbind/into-the-abyss-evaluating-active-directory-smb-shares-on-scale-secure360-251762721&lt;/a&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Vocabulary&lt;/h1&gt; &#xA;&lt;p&gt;PowerHuntShares will inventory SMB share ACLs configured with &#34;excessive privileges&#34; and highlight &#34;high risk&#34; ACLs. Below is how those are defined in this context.&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;Excessive Privileges&lt;/strong&gt;&lt;br&gt; Excessive read and write share permissions have been defined as any network share ACL containing an explicit ACE (Access Control Entry) for the &#34;Everyone&#34;, &#34;Authenticated Users&#34;, &#34;BUILTIN\Users&#34;, &#34;Domain Users&#34;, or &#34;Domain Computers&#34; groups. All provide domain users access to the affected shares due to privilege inheritance issues. Note there is a parameter that allow operators to add their own target groups.&lt;br&gt; Below is some additional background:&lt;br&gt;&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Everyone is a direct reference that applies to both unauthenticated and authenticated users. Typically only a null session is required to access those resources.&lt;/li&gt; &#xA; &lt;li&gt;BUILTIN\Users contains Authenticated Users&lt;/li&gt; &#xA; &lt;li&gt;Authenticated Users contains Domain Users on domain joined systems. That&#39;s why Domain Users can access a share when the share permissions have been assigned to &#34;BUILTIN\Users&#34;.&lt;/li&gt; &#xA; &lt;li&gt;Domain Users is a direct reference&lt;/li&gt; &#xA; &lt;li&gt;Domain Users can also create up to 10 computer accounts by default that get placed in the Domain Computers group&lt;/li&gt; &#xA; &lt;li&gt;Domain Users that have local administrative access to a domain joined computer can also impersonate the computer account.&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;Please Note: Share permissions can be overruled by NTFS permissions. Also, be aware that testing excluded share names containing the following keywords: &lt;/p&gt;&#xA;&lt;pre&gt;print$, prnproc$, printer, netlogon,and sysvol&lt;/pre&gt;&#xA;&lt;p&gt;&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;High Risk Shares&lt;/strong&gt;&lt;br&gt; In the context of this report, high risk shares have been defined as shares that provide unauthorized remote access to a system or application. By default, that includes the shares &lt;/p&gt;&#xA;&lt;pre&gt; wwwroot, inetpub, c$, and admin$   &lt;/pre&gt; However, additional exposures may exist that are not called out beyond that.&#xA;&lt;p&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Example Commands&lt;/h1&gt; &#xA;&lt;p&gt;Important Note: All commands should be run as an unprivileged domain user.&lt;/p&gt; &#xA;&lt;pre&gt;&#xA;.EXAMPLE 1: Run from a domain computer. Performs Active Directory computer discovery by default.&#xA;PS C:\temp\test&amp;gt; Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\temp\test &#xA;&#xA;.EXAMPLE 2: Run from a domain computer with alternative domain credentials. Performs Active Directory computer discovery by default.&#xA;PS C:\temp\test&amp;gt; Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\temp\test -Credentials domain\user&#xA;&#xA;.EXAMPLE 3: Run from a domain computer as current user. Target hosts in a file. One per line.&#xA;PS C:\temp\test&amp;gt; Invoke-HuntSMBShares -Threads 100 -OutputDirectory c:\temp\test  -HostList c:\temp\hosts.txt      &#xA;&#xA;.EXAMPLE 4: Run from a non-domain computer with credential. Performs Active Directory computer discovery by default.&#xA;C:\temp\test&amp;gt; runas /netonly /user:domain\user PowerShell.exe&#xA;PS C:\temp\test&amp;gt; Import-Module Invoke-HuntSMBShares.ps1&#xA;PS C:\temp\test&amp;gt; Invoke-HuntSMBShares -Threads 100 -RunSpaceTimeOut 10 -OutputDirectory c:\folder\ -DomainController 10.1.1.1 -Credential domain\user &#xA;&#xA;===============================================================&#xA;PowerHuntShares&#xA;===============================================================&#xA; This function automates the following tasks:     &#xA;&#xA; o Determine current computer&#39;s domain&#xA; o Enumerate domain computers        &#xA; o Filter for computers that respond to ping reqeusts          &#xA; o Filter for computers that have TCP 445 open and accessible  &#xA; o Enumerate SMB shares &#xA; o Enumerate SMB share permissions   &#xA; o Identify shares with potentially excessive privielges       &#xA; o Identify shares that provide reads &amp;amp; write access           &#xA; o Identify shares thare are high risk&#xA; o Identify common share owners, names, &amp;amp; directory listings   &#xA; o Generate creation, last written, &amp;amp; last accessed timelines&#xA; o Generate html summary report and detailed csv files         &#xA;&#xA; Note: This can take hours to run in large environments.       &#xA;---------------------------------------------------------------&#xA;|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||&#xA;---------------------------------------------------------------&#xA;SHARE DISCOVERY      &#xA;---------------------------------------------------------------&#xA;[*][03/01/2021 09:35] Scan Start&#xA;[*][03/01/2021 09:35] Output Directory: c:\temp\smbshares\SmbShareHunt-03012021093504&#xA;[*][03/01/2021 09:35] Successful connection to domain controller: dc1.demo.local&#xA;[*][03/01/2021 09:35] Performing LDAP query for computers associated with the demo.local domain&#xA;[*][03/01/2021 09:35] - 245 computers found&#xA;[*][03/01/2021 09:35] Pinging 245 computers&#xA;[*][03/01/2021 09:35] - 55 computers responded to ping requests.&#xA;[*][03/01/2021 09:35] Checking if TCP Port 445 is open on 55 computers&#xA;[*][03/01/2021 09:36] - 49 computers have TCP port 445 open.&#xA;[*][03/01/2021 09:36] Getting a list of SMB shares from 49 computers&#xA;[*][03/01/2021 09:36] - 217 SMB shares were found.&#xA;[*][03/01/2021 09:36] Getting share permissions from 217 SMB shares&#xA;[*][03/01/2021 09:37] - 374 share permissions were enumerated.&#xA;[*][03/01/2021 09:37] Getting directory listings from 33 SMB shares&#xA;[*][03/01/2021 09:37] - Targeting up to 3 nested directory levels&#xA;[*][03/01/2021 09:37] - 563 files and folders were enumerated.&#xA;[*][03/01/2021 09:37] Identifying potentially excessive share permissions&#xA;[*][03/01/2021 09:37] - 33 potentially excessive privileges were found across 12 systems..&#xA;[*][03/01/2021 09:37] Scan Complete&#xA;---------------------------------------------------------------&#xA;SHARE ANALYSIS      &#xA;---------------------------------------------------------------&#xA;[*][03/01/2021 09:37] Analysis Start&#xA;[*][03/01/2021 09:37] - 14 shares can be read across 12 systems.&#xA;[*][03/01/2021 09:37] - 1 shares can be written to across 1 systems.&#xA;[*][03/01/2021 09:37] - 46 shares are considered non-default across 32 systems.&#xA;[*][03/01/2021 09:37] - 0 shares are considered high risk across 0 systems&#xA;[*][03/01/2021 09:37] - Identified top 5 owners of excessive shares.&#xA;[*][03/01/2021 09:37] - Identified top 5 share groups.&#xA;[*][03/01/2021 09:37] - Identified top 5 share names.&#xA;[*][03/01/2021 09:37] - Identified shares created in last 90 days.&#xA;[*][03/01/2021 09:37] - Identified shares accessed in last 90 days.&#xA;[*][03/01/2021 09:37] - Identified shares modified in last 90 days.&#xA;[*][03/01/2021 09:37] Analysis Complete&#xA;---------------------------------------------------------------&#xA;SHARE REPORT SUMMARY      &#xA;---------------------------------------------------------------&#xA;[*][03/01/2021 09:37] Domain: demo.local&#xA;[*][03/01/2021 09:37] Start time: 03/01/2021 09:35:04&#xA;[*][03/01/2021 09:37] End time: 03/01/2021 09:37:27&#xA;[*][03/01/2021 09:37] Run time: 00:02:23.2759086&#xA;[*][03/01/2021 09:37] &#xA;[*][03/01/2021 09:37] COMPUTER SUMMARY&#xA;[*][03/01/2021 09:37] - 245 domain computers found.&#xA;[*][03/01/2021 09:37] - 55 (22.45%) domain computers responded to ping.&#xA;[*][03/01/2021 09:37] - 49 (20.00%) domain computers had TCP port 445 accessible.&#xA;[*][03/01/2021 09:37] - 32 (13.06%) domain computers had shares that were non-default.&#xA;[*][03/01/2021 09:37] - 12 (4.90%) domain computers had shares with potentially excessive privileges.&#xA;[*][03/01/2021 09:37] - 12 (4.90%) domain computers had shares that allowed READ access.&#xA;[*][03/01/2021 09:37] - 1 (0.41%) domain computers had shares that allowed WRITE access.&#xA;[*][03/01/2021 09:37] - 0 (0.00%) domain computers had shares that are HIGH RISK.&#xA;[*][03/01/2021 09:37] &#xA;[*][03/01/2021 09:37] SHARE SUMMARY&#xA;[*][03/01/2021 09:37] - 217 shares were found. We expect a minimum of 98 shares&#xA;[*][03/01/2021 09:37]   because 49 systems had open ports and there are typically two default shares.&#xA;[*][03/01/2021 09:37] - 46 (21.20%) shares across 32 systems were non-default.&#xA;[*][03/01/2021 09:37] - 14 (6.45%) shares across 12 systems are configured with 33 potentially excessive ACLs.&#xA;[*][03/01/2021 09:37] - 14 (6.45%) shares across 12 systems allowed READ access.&#xA;[*][03/01/2021 09:37] - 1 (0.46%) shares across 1 systems allowed WRITE access.&#xA;[*][03/01/2021 09:37] - 0 (0.00%) shares across 0 systems are considered HIGH RISK.&#xA;[*][03/01/2021 09:37] &#xA;[*][03/01/2021 09:37] SHARE ACL SUMMARY&#xA;[*][03/01/2021 09:37] - 374 ACLs were found.&#xA;[*][03/01/2021 09:37] - 374 (100.00%) ACLs were associated with non-default shares.&#xA;[*][03/01/2021 09:37] - 33 (8.82%) ACLs were found to be potentially excessive.&#xA;[*][03/01/2021 09:37] - 32 (8.56%) ACLs were found that allowed READ access.&#xA;[*][03/01/2021 09:37] - 1 (0.27%) ACLs were found that allowed WRITE access.&#xA;[*][03/01/2021 09:37] - 0 (0.00%) ACLs were found that are associated with HIGH RISK share names.&#xA;[*][03/01/2021 09:37] &#xA;[*][03/01/2021 09:37] - The 5 most common share names are:&#xA;[*][03/01/2021 09:37] - 9 of 14 (64.29%) discovered shares are associated with the top 5 share names.&#xA;[*][03/01/2021 09:37]   - 4 backup&#xA;[*][03/01/2021 09:37]   - 2 ssms&#xA;[*][03/01/2021 09:37]   - 1 test2&#xA;[*][03/01/2021 09:37]   - 1 test1&#xA;[*][03/01/2021 09:37]   - 1 users&#xA;[*] -----------------------------------------------&#xA;&lt;/pre&gt; &#xA;&lt;h1&gt;HTML Report Examples&lt;/h1&gt; &#xA;&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/NetSPI/PowerHuntShares/main/summary-report.png&#34; alt=&#34;HtmlReport1&#34;&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Credits&lt;/h1&gt; &#xA;&lt;p&gt;&lt;strong&gt;Author&lt;/strong&gt;&lt;br&gt; Scott Sutherland (@_nullbind)&lt;br&gt;&lt;/p&gt; &#xA;&lt;p&gt;&lt;strong&gt;Open-Source Code Used&lt;/strong&gt; &lt;br&gt; These individuals wrote open source code that was used as part of this project. A big thank you goes out them and their work!&lt;br&gt;&lt;/p&gt; &#xA;&lt;table&gt; &#xA; &lt;thead&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;th align=&#34;left&#34;&gt;Name&lt;/th&gt; &#xA;   &lt;th align=&#34;left&#34;&gt;Site&lt;/th&gt; &#xA;  &lt;/tr&gt; &#xA; &lt;/thead&gt; &#xA; &lt;tbody&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;Will Schroeder (@harmj0y)&lt;/td&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;&lt;a href=&#34;https://github.com/PowerShellMafia/PowerSploit/raw/master/Recon/PowerView.ps1&#34;&gt;https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1&lt;/a&gt;&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;Warren F (@pscookiemonster)&lt;/td&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;&lt;a href=&#34;https://github.com/RamblingCookieMonster/Invoke-Parallel&#34;&gt;https://github.com/RamblingCookieMonster/Invoke-Parallel&lt;/a&gt;&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA;  &lt;tr&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;Luben Kirov&lt;/td&gt; &#xA;   &lt;td align=&#34;left&#34;&gt;&lt;a href=&#34;http://www.gi-architects.co.uk/2016/02/powershell-check-if-ip-or-subnet-matchesfits/&#34;&gt;http://www.gi-architects.co.uk/2016/02/powershell-check-if-ip-or-subnet-matchesfits/&lt;/a&gt;&lt;/td&gt; &#xA;  &lt;/tr&gt; &#xA; &lt;/tbody&gt; &#xA;&lt;/table&gt; &#xA;&lt;p&gt;&lt;strong&gt;License&lt;/strong&gt;&lt;br&gt; BSD 3-Clause&lt;/p&gt; &#xA;&lt;h2&gt;Todos&lt;/h2&gt; &#xA;&lt;p&gt;&lt;strong&gt;Pending Fixes/Bugs&lt;/strong&gt;&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Update code to avoid defender&lt;/li&gt; &#xA; &lt;li&gt;Fix file listing formating on data insight pages&lt;/li&gt; &#xA; &lt;li&gt;IPv6 addresses dont show up in subnets summary&lt;/li&gt; &#xA; &lt;li&gt;ACLs associated with Builtin\Users sometimes shows up as LocalSystem under undefined conditions, and as a result, doesnt show up in the Excessive Privileges export. - Thanks Sam!&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;&lt;strong&gt;Pending Features&lt;/strong&gt;&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;Add ability to specify additional groups to target&lt;/li&gt; &#xA; &lt;li&gt;Add directory listing to insights page.&lt;/li&gt; &#xA; &lt;li&gt;Add ability to grab system OS information for data insights.&lt;/li&gt; &#xA; &lt;li&gt;Add visualization: Visual squares with coloring mapped to share volume density by subnet or ip?.&lt;/li&gt; &#xA; &lt;li&gt;Add file type search. (half coded) + add to data insights.&lt;/li&gt; &#xA; &lt;li&gt;Add file content search.&lt;/li&gt; &#xA; &lt;li&gt;Add DontExcludePrintShares option&lt;/li&gt; &#xA; &lt;li&gt;Add auto targeting of groups that contain a large % of the user population; over 70% (make configurable). Add as option.&lt;/li&gt; &#xA; &lt;li&gt;Add configuration fid: netlogon and sysvol you may get access denied when using windows 10 unless the setting below is configured. Automat a check for this, and attempt to modify if privs are at correct level. gpedit.msc, go to Computer -&amp;gt; Administrative Templates -&amp;gt; Network -&amp;gt; Network Provider -&amp;gt; Hardened UNC Paths, enable the policy and click &#34;Show&#34; button. Enter your server name (* for all servers) into &#34;Value name&#34; and enter the folowing text &#34;RequireMutualAuthentication=0,RequireIntegrity=0,RequirePrivacy=0&#34; wihtout quotes into the &#34;Value&#34; field.&lt;/li&gt; &#xA; &lt;li&gt;Add an interesting shares based on names to data insights. example: sql, backup, password, etc.&lt;/li&gt; &#xA; &lt;li&gt;Add active sessions data to help identify potential owners/users of share.&lt;/li&gt; &#xA; &lt;li&gt;Pull spns and computer description/spn account descriptions to help identify owner/business unit.&lt;/li&gt; &#xA; &lt;li&gt;Create bloodhound import file / edge (highrisk share)&lt;/li&gt; &#xA; &lt;li&gt;Research to identify additional high risk share names based on common technology&lt;/li&gt; &#xA; &lt;li&gt;Add better support for IPv6&lt;/li&gt; &#xA; &lt;li&gt;Dynamic identification of spikes in high risk share creation/common groupings, need to better summarize supporting detail beyond just the timeline. For each of the data insights, add average number of shares created for insight grouping by year/month (for folder hash / name etc), and the increase the month/year it spikes. (attempt to provide some historical context); maybe even list the most common non default directories being used by each of those. Potentially adding &#34;first seen date&#34; as well.&lt;/li&gt; &#xA;&lt;/ul&gt;</summary>
  </entry>
</feed>