<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub Go Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2023-03-12T01:34:57Z</updated>
  <subtitle>Daily Trending of Go in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>DATA-DOG/go-sqlmock</title>
    <updated>2023-03-12T01:34:57Z</updated>
    <id>tag:github.com,2023-03-12:/DATA-DOG/go-sqlmock</id>
    <link href="https://github.com/DATA-DOG/go-sqlmock" rel="alternate"></link>
    <summary type="html">&lt;p&gt;Sql mock driver for golang to test database interactions&lt;/p&gt;&lt;hr&gt;&lt;p&gt;&lt;a href=&#34;https://travis-ci.org/DATA-DOG/go-sqlmock&#34;&gt;&lt;img src=&#34;https://travis-ci.org/DATA-DOG/go-sqlmock.svg?sanitize=true&#34; alt=&#34;Build Status&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://godoc.org/github.com/DATA-DOG/go-sqlmock&#34;&gt;&lt;img src=&#34;https://godoc.org/github.com/DATA-DOG/go-sqlmock?status.svg?sanitize=true&#34; alt=&#34;GoDoc&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://goreportcard.com/report/github.com/DATA-DOG/go-sqlmock&#34;&gt;&lt;img src=&#34;https://goreportcard.com/badge/github.com/DATA-DOG/go-sqlmock&#34; alt=&#34;Go Report Card&#34;&gt;&lt;/a&gt; &lt;a href=&#34;https://codecov.io/github/DATA-DOG/go-sqlmock&#34;&gt;&lt;img src=&#34;https://codecov.io/github/DATA-DOG/go-sqlmock/branch/master/graph/badge.svg?sanitize=true&#34; alt=&#34;codecov.io&#34;&gt;&lt;/a&gt;&lt;/p&gt; &#xA;&lt;h1&gt;Sql driver mock for Golang&lt;/h1&gt; &#xA;&lt;p&gt;&lt;strong&gt;sqlmock&lt;/strong&gt; is a mock library implementing &lt;a href=&#34;https://godoc.org/database/sql/driver&#34;&gt;sql/driver&lt;/a&gt;. Which has one and only purpose - to simulate any &lt;strong&gt;sql&lt;/strong&gt; driver behavior in tests, without needing a real database connection. It helps to maintain correct &lt;strong&gt;TDD&lt;/strong&gt; workflow.&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;this library is now complete and stable. (you may not find new changes for this reason)&lt;/li&gt; &#xA; &lt;li&gt;supports concurrency and multiple connections.&lt;/li&gt; &#xA; &lt;li&gt;supports &lt;strong&gt;go1.8&lt;/strong&gt; Context related feature mocking and Named sql parameters.&lt;/li&gt; &#xA; &lt;li&gt;does not require any modifications to your source code.&lt;/li&gt; &#xA; &lt;li&gt;the driver allows to mock any sql driver method behavior.&lt;/li&gt; &#xA; &lt;li&gt;has strict by default expectation order matching.&lt;/li&gt; &#xA; &lt;li&gt;has no third party dependencies.&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; in &lt;strong&gt;v1.2.0&lt;/strong&gt; &lt;strong&gt;sqlmock.Rows&lt;/strong&gt; has changed to struct from interface, if you were using any type references to that interface, you will need to switch it to a pointer struct type. Also, &lt;strong&gt;sqlmock.Rows&lt;/strong&gt; were used to implement &lt;strong&gt;driver.Rows&lt;/strong&gt; interface, which was not required or useful for mocking and was removed. Hope it will not cause issues.&lt;/p&gt; &#xA;&lt;h2&gt;Looking for maintainers&lt;/h2&gt; &#xA;&lt;p&gt;I do not have much spare time for this library and willing to transfer the repository ownership to person or an organization motivated to maintain it. Open up a conversation if you are interested. See #230.&lt;/p&gt; &#xA;&lt;h2&gt;Install&lt;/h2&gt; &#xA;&lt;pre&gt;&lt;code&gt;go get github.com/DATA-DOG/go-sqlmock&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Documentation and Examples&lt;/h2&gt; &#xA;&lt;p&gt;Visit &lt;a href=&#34;http://godoc.org/github.com/DATA-DOG/go-sqlmock&#34;&gt;godoc&lt;/a&gt; for general examples and public api reference. See &lt;strong&gt;.travis.yml&lt;/strong&gt; for supported &lt;strong&gt;go&lt;/strong&gt; versions. Different use case, is to functionally test with a real database - &lt;a href=&#34;https://github.com/DATA-DOG/go-txdb&#34;&gt;go-txdb&lt;/a&gt; all database related actions are isolated within a single transaction so the database can remain in the same state.&lt;/p&gt; &#xA;&lt;p&gt;See implementation examples:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/tree/master/examples/blog&#34;&gt;blog API server&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/tree/master/examples/orders&#34;&gt;the same orders example&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h3&gt;Something you may want to test, assuming you use the &lt;a href=&#34;https://github.com/go-sql-driver/mysql&#34;&gt;go-mysql-driver&lt;/a&gt;&lt;/h3&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main&#xA;&#xA;import (&#xA;&#x9;&#34;database/sql&#34;&#xA;&#xA;&#x9;_ &#34;github.com/go-sql-driver/mysql&#34;&#xA;)&#xA;&#xA;func recordStats(db *sql.DB, userID, productID int64) (err error) {&#xA;&#x9;tx, err := db.Begin()&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;return&#xA;&#x9;}&#xA;&#xA;&#x9;defer func() {&#xA;&#x9;&#x9;switch err {&#xA;&#x9;&#x9;case nil:&#xA;&#x9;&#x9;&#x9;err = tx.Commit()&#xA;&#x9;&#x9;default:&#xA;&#x9;&#x9;&#x9;tx.Rollback()&#xA;&#x9;&#x9;}&#xA;&#x9;}()&#xA;&#xA;&#x9;if _, err = tx.Exec(&#34;UPDATE products SET views = views + 1&#34;); err != nil {&#xA;&#x9;&#x9;return&#xA;&#x9;}&#xA;&#x9;if _, err = tx.Exec(&#34;INSERT INTO product_viewers (user_id, product_id) VALUES (?, ?)&#34;, userID, productID); err != nil {&#xA;&#x9;&#x9;return&#xA;&#x9;}&#xA;&#x9;return&#xA;}&#xA;&#xA;func main() {&#xA;&#x9;// @NOTE: the real connection is not required for tests&#xA;&#x9;db, err := sql.Open(&#34;mysql&#34;, &#34;root@/blog&#34;)&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;panic(err)&#xA;&#x9;}&#xA;&#x9;defer db.Close()&#xA;&#xA;&#x9;if err = recordStats(db, 1 /*some user id*/, 5 /*some product id*/); err != nil {&#xA;&#x9;&#x9;panic(err)&#xA;&#x9;}&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h3&gt;Tests with sqlmock&lt;/h3&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main&#xA;&#xA;import (&#xA;&#x9;&#34;fmt&#34;&#xA;&#x9;&#34;testing&#34;&#xA;&#xA;&#x9;&#34;github.com/DATA-DOG/go-sqlmock&#34;&#xA;)&#xA;&#xA;// a successful case&#xA;func TestShouldUpdateStats(t *testing.T) {&#xA;&#x9;db, mock, err := sqlmock.New()&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;t.Fatalf(&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;, err)&#xA;&#x9;}&#xA;&#x9;defer db.Close()&#xA;&#xA;&#x9;mock.ExpectBegin()&#xA;&#x9;mock.ExpectExec(&#34;UPDATE products&#34;).WillReturnResult(sqlmock.NewResult(1, 1))&#xA;&#x9;mock.ExpectExec(&#34;INSERT INTO product_viewers&#34;).WithArgs(2, 3).WillReturnResult(sqlmock.NewResult(1, 1))&#xA;&#x9;mock.ExpectCommit()&#xA;&#xA;&#x9;// now we execute our method&#xA;&#x9;if err = recordStats(db, 2, 3); err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;error was not expected while updating stats: %s&#34;, err)&#xA;&#x9;}&#xA;&#xA;&#x9;// we make sure that all expectations were met&#xA;&#x9;if err := mock.ExpectationsWereMet(); err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;there were unfulfilled expectations: %s&#34;, err)&#xA;&#x9;}&#xA;}&#xA;&#xA;// a failing test case&#xA;func TestShouldRollbackStatUpdatesOnFailure(t *testing.T) {&#xA;&#x9;db, mock, err := sqlmock.New()&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;t.Fatalf(&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;, err)&#xA;&#x9;}&#xA;&#x9;defer db.Close()&#xA;&#xA;&#x9;mock.ExpectBegin()&#xA;&#x9;mock.ExpectExec(&#34;UPDATE products&#34;).WillReturnResult(sqlmock.NewResult(1, 1))&#xA;&#x9;mock.ExpectExec(&#34;INSERT INTO product_viewers&#34;).&#xA;&#x9;&#x9;WithArgs(2, 3).&#xA;&#x9;&#x9;WillReturnError(fmt.Errorf(&#34;some error&#34;))&#xA;&#x9;mock.ExpectRollback()&#xA;&#xA;&#x9;// now we execute our method&#xA;&#x9;if err = recordStats(db, 2, 3); err == nil {&#xA;&#x9;&#x9;t.Errorf(&#34;was expecting an error, but there was none&#34;)&#xA;&#x9;}&#xA;&#xA;&#x9;// we make sure that all expectations were met&#xA;&#x9;if err := mock.ExpectationsWereMet(); err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;there were unfulfilled expectations: %s&#34;, err)&#xA;&#x9;}&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Customize SQL query matching&lt;/h2&gt; &#xA;&lt;p&gt;There were plenty of requests from users regarding SQL query string validation or different matching option. We have now implemented the &lt;code&gt;QueryMatcher&lt;/code&gt; interface, which can be passed through an option when calling &lt;code&gt;sqlmock.New&lt;/code&gt; or &lt;code&gt;sqlmock.NewWithDSN&lt;/code&gt;.&lt;/p&gt; &#xA;&lt;p&gt;This now allows to include some library, which would allow for example to parse and validate &lt;code&gt;mysql&lt;/code&gt; SQL AST. And create a custom QueryMatcher in order to validate SQL in sophisticated ways.&lt;/p&gt; &#xA;&lt;p&gt;By default, &lt;strong&gt;sqlmock&lt;/strong&gt; is preserving backward compatibility and default query matcher is &lt;code&gt;sqlmock.QueryMatcherRegexp&lt;/code&gt; which uses expected SQL string as a regular expression to match incoming query string. There is an equality matcher: &lt;code&gt;QueryMatcherEqual&lt;/code&gt; which will do a full case sensitive match.&lt;/p&gt; &#xA;&lt;p&gt;In order to customize the QueryMatcher, use the following:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;&#x9;db, mock, err := sqlmock.New(sqlmock.QueryMatcherOption(sqlmock.QueryMatcherEqual))&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;The query matcher can be fully customized based on user needs. &lt;strong&gt;sqlmock&lt;/strong&gt; will not provide a standard sql parsing matchers, since various drivers may not follow the same SQL standard.&lt;/p&gt; &#xA;&lt;h2&gt;Matching arguments like time.Time&lt;/h2&gt; &#xA;&lt;p&gt;There may be arguments which are of &lt;code&gt;struct&lt;/code&gt; type and cannot be compared easily by value like &lt;code&gt;time.Time&lt;/code&gt;. In this case &lt;strong&gt;sqlmock&lt;/strong&gt; provides an &lt;a href=&#34;https://godoc.org/github.com/DATA-DOG/go-sqlmock#Argument&#34;&gt;Argument&lt;/a&gt; interface which can be used in more sophisticated matching. Here is a simple example of time argument matching:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;type AnyTime struct{}&#xA;&#xA;// Match satisfies sqlmock.Argument interface&#xA;func (a AnyTime) Match(v driver.Value) bool {&#xA;&#x9;_, ok := v.(time.Time)&#xA;&#x9;return ok&#xA;}&#xA;&#xA;func TestAnyTimeArgument(t *testing.T) {&#xA;&#x9;t.Parallel()&#xA;&#x9;db, mock, err := sqlmock.New()&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;, err)&#xA;&#x9;}&#xA;&#x9;defer db.Close()&#xA;&#xA;&#x9;mock.ExpectExec(&#34;INSERT INTO users&#34;).&#xA;&#x9;&#x9;WithArgs(&#34;john&#34;, AnyTime{}).&#xA;&#x9;&#x9;WillReturnResult(sqlmock.NewResult(1, 1))&#xA;&#xA;&#x9;_, err = db.Exec(&#34;INSERT INTO users(name, created_at) VALUES (?, ?)&#34;, &#34;john&#34;, time.Now())&#xA;&#x9;if err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;error &#39;%s&#39; was not expected, while inserting a row&#34;, err)&#xA;&#x9;}&#xA;&#xA;&#x9;if err := mock.ExpectationsWereMet(); err != nil {&#xA;&#x9;&#x9;t.Errorf(&#34;there were unfulfilled expectations: %s&#34;, err)&#xA;&#x9;}&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;It only asserts that argument is of &lt;code&gt;time.Time&lt;/code&gt; type.&lt;/p&gt; &#xA;&lt;h2&gt;Run tests&lt;/h2&gt; &#xA;&lt;pre&gt;&lt;code&gt;go test -race&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Change Log&lt;/h2&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;strong&gt;2019-04-06&lt;/strong&gt; - added functionality to mock a sql MetaData request&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2019-02-13&lt;/strong&gt; - added &lt;code&gt;go.mod&lt;/code&gt; removed the references and suggestions using &lt;code&gt;gopkg.in&lt;/code&gt;.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2018-12-11&lt;/strong&gt; - added expectation of Rows to be closed, while mocking expected query.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2018-12-11&lt;/strong&gt; - introduced an option to provide &lt;strong&gt;QueryMatcher&lt;/strong&gt; in order to customize SQL query matching.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2017-09-01&lt;/strong&gt; - it is now possible to expect that prepared statement will be closed, using &lt;strong&gt;ExpectedPrepare.WillBeClosed&lt;/strong&gt;.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2017-02-09&lt;/strong&gt; - implemented support for &lt;strong&gt;go1.8&lt;/strong&gt; features. &lt;strong&gt;Rows&lt;/strong&gt; interface was changed to struct but contains all methods as before and should maintain backwards compatibility. &lt;strong&gt;ExpectedQuery.WillReturnRows&lt;/strong&gt; may now accept multiple row sets.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2016-11-02&lt;/strong&gt; - &lt;code&gt;db.Prepare()&lt;/code&gt; was not validating expected prepare SQL query. It should still be validated even if Exec or Query is not executed on that prepared statement.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2016-02-23&lt;/strong&gt; - added &lt;strong&gt;sqlmock.AnyArg()&lt;/strong&gt; function to provide any kind of argument matcher.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2016-02-23&lt;/strong&gt; - convert expected arguments to driver.Value as natural driver does, the change may affect time.Time comparison and will be stricter. See &lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/issues/31&#34;&gt;issue&lt;/a&gt;.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2015-08-27&lt;/strong&gt; - &lt;strong&gt;v1&lt;/strong&gt; api change, concurrency support, all known issues fixed.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2014-08-16&lt;/strong&gt; instead of &lt;strong&gt;panic&lt;/strong&gt; during reflect type mismatch when comparing query arguments - now return error&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2014-08-14&lt;/strong&gt; added &lt;strong&gt;sqlmock.NewErrorResult&lt;/strong&gt; which gives an option to return driver.Result with errors for interface methods, see &lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/issues/5&#34;&gt;issue&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2014-05-29&lt;/strong&gt; allow to match arguments in more sophisticated ways, by providing an &lt;strong&gt;sqlmock.Argument&lt;/strong&gt; interface&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2014-04-21&lt;/strong&gt; introduce &lt;strong&gt;sqlmock.New()&lt;/strong&gt; to open a mock database connection for tests. This method calls sql.DB.Ping to ensure that connection is open, see &lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/issues/4&#34;&gt;issue&lt;/a&gt;. This way on Close it will surely assert if all expectations are met, even if database was not triggered at all. The old way is still available, but it is advisable to call db.Ping manually before asserting with db.Close.&lt;/li&gt; &#xA; &lt;li&gt;&lt;strong&gt;2014-02-14&lt;/strong&gt; RowsFromCSVString is now a part of Rows interface named as FromCSVString. It has changed to allow more ways to construct rows and to easily extend this API in future. See &lt;a href=&#34;https://github.com/DATA-DOG/go-sqlmock/issues/1&#34;&gt;issue 1&lt;/a&gt; &lt;strong&gt;RowsFromCSVString&lt;/strong&gt; is deprecated and will be removed in future&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h2&gt;Contributions&lt;/h2&gt; &#xA;&lt;p&gt;Feel free to open a pull request. Note, if you wish to contribute an extension to public (exported methods or types) - please open an issue before, to discuss whether these changes can be accepted. All backward incompatible changes are and will be treated cautiously&lt;/p&gt; &#xA;&lt;h2&gt;License&lt;/h2&gt; &#xA;&lt;p&gt;The &lt;a href=&#34;http://en.wikipedia.org/wiki/BSD_licenses&#34;&gt;three clause BSD license&lt;/a&gt;&lt;/p&gt;</summary>
  </entry>
</feed>