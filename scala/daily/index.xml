<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>GitHub Scala Daily Trending</title>
  <id>http://mshibanami.github.io/GitHubTrendingRSS</id>
  <updated>2023-07-03T01:48:20Z</updated>
  <subtitle>Daily Trending of Scala in GitHub</subtitle>
  <link href="http://mshibanami.github.io/GitHubTrendingRSS"></link>
  <entry>
    <title>guardian/amigo</title>
    <updated>2023-07-03T01:48:20Z</updated>
    <id>tag:github.com,2023-07-03:/guardian/amigo</id>
    <link href="https://github.com/guardian/amigo" rel="alternate"></link>
    <summary type="html">&lt;p&gt;AMIgo: An AMI bakery&lt;/p&gt;&lt;hr&gt;&lt;h1&gt;AMIgo&lt;/h1&gt; &#xA;&lt;p&gt;AMIgo is an application for baking AMIs (Amazon Machine Images). For information on how to use Amigo baked AMIs with Riffraff check &lt;a href=&#34;https://raw.githubusercontent.com/guardian/amigo/main/docs/riffraff-integration.md&#34;&gt;here&lt;/a&gt;. This project is built in &lt;a href=&#34;https://teamcity.gutools.co.uk/buildConfiguration/Tools_Amigo&#34;&gt;teamcity&lt;/a&gt;.&lt;/p&gt; &#xA;&lt;h2&gt;Terminology&lt;/h2&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt; &lt;p&gt;A &lt;strong&gt;base image&lt;/strong&gt; is the source AMI to use as the basis for an image. For example you might have an &#34;Ubuntu Wily&#34; base image.&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;A &lt;strong&gt;role&lt;/strong&gt; is something installed or configured on the machine. For example if you want your machine to have a JVM, Node and nginx pre-installed, you would assign the corresponding roles to your image. Currently roles are implemented as Ansible roles.&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;A &lt;strong&gt;recipe&lt;/strong&gt; is a description of how to bake your AMI. Making a recipe consists of choosing a base image and deciding which roles to assign. For example you might have a recipe that builds an image based on Ubuntu Wily and installs a JVM, Node and nginx.&lt;/p&gt; &lt;/li&gt; &#xA; &lt;li&gt; &lt;p&gt;A &lt;strong&gt;bake&lt;/strong&gt; is a single execution of a recipe. The result of a bake is an AMI.&lt;/p&gt; &lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;h2&gt;Implementation&lt;/h2&gt; &#xA;&lt;p&gt;AMIgo is implemented as a Play application. It uses Packer and Ansible to bake AMIs.&lt;/p&gt; &#xA;&lt;h3&gt;AMI baking process&lt;/h3&gt; &#xA;&lt;p&gt;Roughly, AMIgo does the following:&lt;/p&gt; &#xA;&lt;ol&gt; &#xA; &lt;li&gt;Dynamically generate an Ansible playbook based on the recipe&#39;s roles&lt;/li&gt; &#xA; &lt;li&gt;Dynamically generate a Packer build configuration file to install and then run Ansible&lt;/li&gt; &#xA; &lt;li&gt;Execute Packer as an external process&lt;/li&gt; &#xA; &lt;li&gt;Parse the Packer output and extract useful information from it&lt;/li&gt; &#xA;&lt;/ol&gt; &#xA;&lt;p&gt;All data (base images, recipes, bakes, bake logs) are stored in DynamoDB. The Dynamo tables are created automatically if they do not exist.&lt;/p&gt; &#xA;&lt;h2&gt;Debugging recipes&lt;/h2&gt; &#xA;&lt;p&gt;When running in an environment that is not &lt;code&gt;PROD&lt;/code&gt; there is an option to &lt;code&gt;Bake with debug enabled&lt;/code&gt;. This passes the &lt;code&gt;-debug&lt;/code&gt; flag through to packer which saves a copy of the SSH key in AMIgos working directory. This makes it possible to SSH onto the instance that is being used to build the AMI.&lt;/p&gt; &#xA;&lt;h2&gt;How to run locally&lt;/h2&gt; &#xA;&lt;h3&gt;Testing ansible scripts without running amigo/packer&lt;/h3&gt; &#xA;&lt;p&gt;&lt;em&gt;Warning: Multipass seems to struggle if running at the same time as the VPN. We recommend not running the VPN when using Multipass locally.&lt;/em&gt;&lt;/p&gt; &#xA;&lt;p&gt;Amigo roles are simply Ansible scripts and can be run independently of Amigo itself. This is often a lot easier than running Amigo itself.&lt;/p&gt; &#xA;&lt;p&gt;To test roles locally, run:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;$ multipass/run.sh&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;This will install &lt;a href=&#34;https://multipass.run/&#34;&gt;Multipass&lt;/a&gt;, a Canonical tool to manage Ubuntu VMs, and execute Ansible roles within it.&lt;/p&gt; &#xA;&lt;p&gt;If you want to run commands/debug directly in the VM then (post installing things via run.sh), run:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;$ multipass shell amigo-test&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;If the Multipass VM is timing out, try deleting and then re-running the script:&lt;/p&gt; &#xA;&lt;pre&gt;&lt;code&gt;$ multipass stop amigo-test&#xA;$ multipass delete amigo-test&#xA;$ multipass purge amigo-test&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;p&gt;You should also disconnect from the VPN too if using it.&lt;/p&gt; &#xA;&lt;h3&gt;Running the full app&lt;/h3&gt; &#xA;&lt;p&gt;Load the &lt;code&gt;deployTools&lt;/code&gt; credentials using Janus, then execute &lt;a href=&#34;https://raw.githubusercontent.com/guardian/amigo/main/script/server&#34;&gt;&lt;code&gt;./script/server&lt;/code&gt;&lt;/a&gt;. This will run the Amigo app locally and the associated packer process should have the sufficient AWS authorization.&lt;/p&gt; &#xA;&lt;p&gt;Note that you must use Java 11 to run this app. There are a few options for switching between Java versions at the time of writing:&lt;/p&gt; &#xA;&lt;ul&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://get-coursier.io/docs/cli-java&#34;&gt;Coursier&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://asdf-vm.com/&#34;&gt;asdf&lt;/a&gt;&lt;/li&gt; &#xA; &lt;li&gt;&lt;a href=&#34;https://sdkman.io/usage&#34;&gt;sdkman&lt;/a&gt;&lt;/li&gt; &#xA;&lt;/ul&gt; &#xA;&lt;details&gt; &#xA; &lt;summary&gt;Previous run locally advice&lt;/summary&gt; &#xA; &lt;p&gt;Install dependencies with &lt;a href=&#34;https://raw.githubusercontent.com/guardian/amigo/main/script/setup&#34;&gt;&lt;code&gt;./script/setup&lt;/code&gt;&lt;/a&gt;&lt;/p&gt; &#xA; &lt;p&gt;(For a faster but messier way of testing your ansible scripts - see &#39;Testing ansible scripts without runing amigo/packer&#39; below.)&lt;/p&gt; &#xA; &lt;p&gt;AMIgo requires Packer to be &lt;a href=&#34;https://www.packer.io/intro/getting-started/install.html&#34;&gt;installed&lt;/a&gt;&lt;/p&gt; &#xA; &lt;p&gt;To run the Play app, you will need credentials in either the &lt;code&gt;deployTools&lt;/code&gt; profile or the default profile.&lt;/p&gt; &#xA; &lt;p&gt;If you want to actually perform a bake, you will need separate credentials for Packer. These must be available either as environment variables or in the default profile. (Packer doesn&#39;t play nicely with named profiles.) I&#39;m not sure whether Packer understands federated credentials, session token, etc. I created an IAM user with limited permissions (see below) and use that user&#39;s credentials.&lt;/p&gt; &#xA; &lt;p&gt;If you have created a custom VPC in your AWS account (i.e. your account contains any VPCs other than the default one), then you will also need to tell Packer which VPC and subnet to use when building images:&lt;/p&gt; &#xA; &lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ cat ~/.configuration-magic/amigo.conf&#xA;packer {&#xA;  vpcId = &#34;vpc-1234abcd&#34;&#xA;  subnetId = &#34;subnet-5678efgh&#34;&#xA;  instanceProfile = &#34;[optional] instance profile name for the box packer will run on&#34;&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA; &lt;p&gt;If you want to use the &lt;code&gt;packages&lt;/code&gt; role to install packages from an S3 bucket then you&#39;ll also need to configure that:&lt;/p&gt; &#xA; &lt;pre&gt;&lt;code class=&#34;language-hocon&#34;&gt;ansible {&#xA;  packages {&#xA;    s3bucket = &#34;your-bucket&#34;&#xA;    s3prefix = &#34;an/optional/prefix/&#34;&#xA;  }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA; &lt;p&gt;Optionally, you may want to set &lt;code&gt;associate_public_ip_address&lt;/code&gt; to true if your subnet does not default to this, to ensure Packer can SSH into your instance.&lt;/p&gt; &#xA; &lt;p&gt;Once you have your credentials and config sorted out, just do:&lt;/p&gt; &#xA; &lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ sbt run&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;/details&gt; &#xA;&lt;h2&gt;How to run the tests&lt;/h2&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ sbt test&#xA;&lt;/code&gt;&lt;/pre&gt; &#xA;&lt;h2&gt;Required AWS permissions for Packer&lt;/h2&gt; &#xA;&lt;pre&gt;&lt;code class=&#34;language-json5&#34;&gt;{&#xA;    &#34;Statement&#34;: [&#xA;        {&#xA;            &#34;Effect&#34;: &#34;Allow&#34;,&#xA;            &#34;Action&#34;: [&#xA;                &#34;ec2:AttachVolume&#34;,&#xA;                &#34;ec2:CreateVolume&#34;,&#xA;                &#34;ec2:DeleteVolume&#34;,&#xA;                &#34;ec2:CreateKeypair&#34;,&#xA;                &#34;ec2:DeleteKeypair&#34;,&#xA;                &#34;ec2:DescribeSubnets&#34;,&#xA;                &#34;ec2:CreateSecurityGroup&#34;,&#xA;                &#34;ec2:DeleteSecurityGroup&#34;,&#xA;                &#34;ec2:AuthorizeSecurityGroupIngress&#34;,&#xA;                &#34;ec2:CreateImage&#34;,&#xA;                &#34;ec2:CopyImage&#34;,&#xA;                &#34;ec2:RunInstances&#34;,&#xA;                &#34;ec2:TerminateInstances&#34;,&#xA;                &#34;ec2:StopInstances&#34;,&#xA;                &#34;ec2:DescribeVolumes&#34;,&#xA;                &#34;ec2:DetachVolume&#34;,&#xA;                &#34;ec2:DescribeInstances&#34;,&#xA;                &#34;ec2:CreateSnapshot&#34;,&#xA;                &#34;ec2:DeleteSnapshot&#34;,&#xA;                &#34;ec2:DescribeSnapshots&#34;,&#xA;                &#34;ec2:DescribeImages&#34;,&#xA;                &#34;ec2:RegisterImage&#34;,&#xA;                &#34;ec2:CreateTags&#34;,&#xA;                &#34;ec2:ModifyImageAttribute&#34;,&#xA;                &#34;iam:*&#34;,&#xA;                &#34;elasticloadbalancing:*&#34;&#xA;            ],&#xA;            &#34;Resource&#34;: &#34;*&#34;&#xA;        }&#xA;    ]&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;</summary>
  </entry>
</feed>